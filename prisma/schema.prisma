// Prisma Schema 文件
// 文档: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// 平台账号表
model PlatformAccount {
  id             Int      @id @default(autoincrement())
  platform       String   // douyin | bilibili | xiaohongshu | kuaishou | tencent | tiktok
  accountName    String   @map("account_name")
  accountId      String?  @map("account_id")
  cookiePath     String   @map("cookie_path")
  
  // 账号信息 (对应 PlatformAccountInfo)
  userId         String?  @map("user_id")       // 平台用户ID
  username       String?  @map("username")      // 用户名/昵称  
  avatar         String?  @map("avatar")        // 头像URL
  followersCount Int?     @map("followers_count") // 粉丝数
  totalFavorited Int?     @map("total_favorited") // 获赞数
  description    String?  @map("description")   // 简介
  
  isActive       Boolean  @default(true) @map("is_active")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  uploadTasks    UploadTask[]
  videos         AccountVideo[]
  themeAccounts  ThemeAccount[]  // 主题库关联

  @@index([platform])
  @@index([isActive])
  @@index([userId])
  @@map("platform_accounts")
}

// 资源库连接配置
model ResourceLibrary {
  id          Int      @id @default(autoincrement())
  name        String   // 资源库名称
  type        String   // local | webdav | smb | ftp
  config      String   // 连接配置 (JSON字符串)
  isActive    Boolean  @default(true) @map("is_active")
  isDefault   Boolean  @default(false) @map("is_default")
  
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  @@index([type])
  @@index([isDefault])
  @@map("resource_libraries")
}

// 上传任务表（关联资源库中的资源）
model UploadTask {
  id            Int      @id @default(autoincrement())
  platformId    Int      @map("platform_id")    // 平台账号ID
  
  account       PlatformAccount @relation(fields: [platformId], references: [id])

  // 资源信息
  resourcePath  String   @map("resource_path")  // 资源在库中的路径
  resourceType  String   @map("resource_type")  // video | image | audio
  libraryId     Int      @map("library_id")     // 资源库ID
  
  // 上传信息
  title         String   // 发布标题
  description   String?  // 发布描述
  tags          String   @default("") // 标签 (逗号分隔的字符串)
  
  // 任务状态
  status        String   @default("pending")     // pending | processing | success | failed
  scheduledAt   DateTime? @map("scheduled_at")   // 计划上传时间
  uploadedAt    DateTime? @map("uploaded_at")    // 实际上传时间
  
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  
  @@index([platformId])
  @@index([status])
  @@map("upload_tasks")
}

// 账号视频数据
model AccountVideo {
  id                 Int      @id @default(autoincrement())
  platformAccountId  Int      @map("platform_account_id")  // 平台账号ID
  videoId            String   @map("video_id")             // 视频唯一ID
  title              String
  coverUrl           String?  @map("cover_url")            // 封面URL
  duration           Int?                                   // 时长（秒）
  publishTime        DateTime? @map("publish_time")        // 发布时间
  status             String?                               // 视频状态
  playCount          Int?     @map("play_count")           // 播放量
  diggCount          Int?     @map("digg_count")           // 点赞数
  commentCount       Int?     @map("comment_count")        // 评论数
  shareCount         Int?     @map("share_count")          // 分享数
  collectCount       Int?     @map("collect_count")        // 收藏数
  extra              String?  @map("extra")                // 额外数据(JSON字符串)
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  account            PlatformAccount @relation(fields: [platformAccountId], references: [id], onDelete: Cascade)

  @@unique([platformAccountId, videoId])
  @@index([platformAccountId])
  @@map("account_videos")
}

// 主题库
model Theme {
  id               Int      @id @default(autoincrement())
  name             String   // 主题库名称
  description      String?  // 主题库简介
  archiveFolderName String  @default("published") @map("archive_folder_name") // 归档文件夹名称
  
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")
  
  // 关联
  themeAccounts    ThemeAccount[]     // 关联的账号
  resourcePaths    ThemeResourcePath[] // 资源路径
  
  @@map("themes")
}

// 主题库与账号的关联表(多对多)
model ThemeAccount {
  id        Int      @id @default(autoincrement())
  themeId   Int      @map("theme_id")
  accountId Int      @map("account_id")
  
  createdAt DateTime @default(now()) @map("created_at")
  
  theme     Theme           @relation(fields: [themeId], references: [id], onDelete: Cascade)
  account   PlatformAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)
  
  @@unique([themeId, accountId])
  @@index([themeId])
  @@index([accountId])
  @@map("theme_accounts")
}

// 主题资源路径
model ThemeResourcePath {
  id          Int      @id @default(autoincrement())
  themeId     Int      @map("theme_id")     // 主题库ID
  libraryId   Int      @map("library_id")   // 资源库ID
  folderPath  String   @map("folder_path")  // 文件夹路径
  
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  theme       Theme @relation(fields: [themeId], references: [id], onDelete: Cascade)
  
  @@unique([themeId, libraryId, folderPath])
  @@index([themeId])
  @@index([libraryId])
  @@map("theme_resource_paths")
}
